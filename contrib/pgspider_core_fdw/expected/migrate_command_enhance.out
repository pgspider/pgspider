-- ===================================================================
-- create FDW objects
-- ===================================================================
--Testcase 1:
CREATE EXTENSION postgres_fdw;
--Testcase 2:
CREATE EXTENSION pgspider_core_fdw;
--Testcase 3:
CREATE EXTENSION pgspider_fdw;
--Testcase 4:
CREATE SERVER pgspider_core_srv FOREIGN DATA WRAPPER pgspider_core_fdw;
--Testcase 5:
CREATE USER MAPPING FOR public SERVER pgspider_core_srv;
DO $d$
    BEGIN
        EXECUTE $$CREATE SERVER postgres_srv1 FOREIGN DATA WRAPPER postgres_fdw
            OPTIONS (host '127.0.0.1',
                     port '15432',
                     dbname 'postgres'
            )$$;
        EXECUTE $$CREATE SERVER postgres_srv2 FOREIGN DATA WRAPPER postgres_fdw
            OPTIONS (host '127.0.0.1',
                     port '25432',
                     dbname 'postgres'
            )$$;
        EXECUTE $$CREATE SERVER postgres_srv3 FOREIGN DATA WRAPPER postgres_fdw
            OPTIONS (host '127.0.0.1',
                     port '35432',
                     dbname 'postgres'
            )$$;
    END;
$d$;
--Testcase 6:
CREATE USER MAPPING FOR public SERVER postgres_srv1
    OPTIONS (user 'postgres', password 'postgres');
--Testcase 7:
CREATE USER MAPPING FOR public SERVER postgres_srv2
    OPTIONS (user 'postgres', password 'postgres');
--Testcase 8:
CREATE USER MAPPING FOR public SERVER postgres_srv3
    OPTIONS (user 'postgres', password 'postgres');
--Testcase 9:
CREATE SERVER pgspider_srv1 FOREIGN DATA WRAPPER pgspider_fdw OPTIONS (host '127.0.0.1', port '14813', dbname 'pgspider');
--Testcase 10:
CREATE USER MAPPING FOR public SERVER pgspider_srv1
    OPTIONS (user 'pgspider', password 'pgspider');
----------------------------------------------------------
-- abnormal case
-- all test case in this section will be ERROR
----------------------------------------------------------
-- Init foreign table
--Testcase 11:
CREATE FOREIGN TABLE test_error (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'test_error');
--Testcase 12:
CREATE DATASOURCE TABLE test_error;
--Testcase 13:
INSERT INTO test_error VALUES (1, 1, 'foo', '2022/10/09 12:00:00 +08', '2022/10/09 12:00:00', '0', DEFAULT);
--Testcase 14:
SELECT * FROM test_error ORDER BY c1;
 c1 | c2 | c3  |              c4              |            c5            | c6 |     c7     
----+----+-----+------------------------------+--------------------------+----+------------
  1 |  1 | foo | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
(1 row)

--
-- Wrong key word
-- Wrong key word order
--
-- ERROR: syntax error
--Testcase 15:
MIGRATED test_error SERVER postgres_srv2; -- wrong key word
ERROR:  syntax error at or near "MIGRATED"
LINE 1: MIGRATED test_error SERVER postgres_srv2;
        ^
--Testcase 16:
MIGRATE FOREIGN TABLE test_error SERVER postgres_srv2; -- redundant word
ERROR:  syntax error at or near "FOREIGN"
LINE 1: MIGRATE FOREIGN TABLE test_error SERVER postgres_srv2;
                ^
--Testcase 17:
MIGRATE TABLE test_error SERVER postgres_srv2 TO ft2; -- wrong key word order
ERROR:  syntax error at or near "TO"
LINE 1: MIGRATE TABLE test_error SERVER postgres_srv2 TO ft2;
                                                      ^
--Testcase 18:
MIGRATE TABLE test_error REPLACE TO ft2 SERVER postgres_srv2; -- redundant word
ERROR:  syntax error at or near "TO"
LINE 1: MIGRATE TABLE test_error REPLACE TO ft2 SERVER postgres_srv2...
                                         ^
--Testcase 20:
CREATE TABLE DATASOURCE test_error; -- wrong key word order
ERROR:  syntax error at or near "test_error"
LINE 1: CREATE TABLE DATASOURCE test_error;
                                ^
--Testcase 21:
CREATE DATA TABLE test_error; -- wrong key word
ERROR:  syntax error at or near "DATA"
LINE 1: CREATE DATA TABLE test_error;
               ^
--Testcase 22:
CREATE NEW DATASOURCE TABLE test_error; -- redundant key word
ERROR:  syntax error at or near "NEW"
LINE 1: CREATE NEW DATASOURCE TABLE test_error;
               ^
--Testcase 23:
DROP TABLE DATASOURCE test_error; -- wrong key word order
ERROR:  syntax error at or near "test_error"
LINE 1: DROP TABLE DATASOURCE test_error;
                              ^
--Testcase 24:
DROP DATA TABLE test_error; -- wrong key word
ERROR:  syntax error at or near "DATA"
LINE 1: DROP DATA TABLE test_error;
             ^
--Testcase 25:
DROP NEW DATASOURCE TABLE test_error; -- redundant key word
ERROR:  syntax error at or near "NEW"
LINE 1: DROP NEW DATASOURCE TABLE test_error;
             ^
-- dest table of MIGRATE command existed
--Testcase 26:
CREATE FOREIGN TABLE test_error2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'test_error2');
--Testcase 27:
CREATE DATASOURCE TABLE test_error2;
-- ERROR: dest table existed
--Testcase 28:
MIGRATE TABLE test_error TO test_error2 SERVER postgres_srv2; -- ERROR
ERROR:  Destination table already existed!
--Testcase 29:
DROP FOREIGN TABLE test_error2;
-- ERROR: Datasource table of dest table of MIGRATE command existed
--Testcase 30:
MIGRATE TABLE test_error TO test_error2 SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'test_error2'); -- ERROR
ERROR:  relation "test_error2" already exists
CONTEXT:  remote SQL command: CREATE TABLE "S 1".test_error2 (c1 integer NOT NULL, c2 integer NOT NULL, c3 text COLLATE "default", c4 timestamp with time zone, c5 timestamp without time zone, c6 character varying(10) COLLATE "default", c7 character(10) COLLATE "default");
-- drop datasource table test_error2
--Testcase 31:
CREATE FOREIGN TABLE test_error2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'test_error2');
--Testcase 32:
DROP DATASOURCE TABLE test_error2;
--Testcase 33:
DROP FOREIGN TABLE test_error2;
-- ERROR: Dest server does not exist
--Testcase 34:
MIGRATE TABLE test_error TO test_error2 SERVER not_exist_server;
ERROR:  server "not_exist_server" does not exist
-- ERROR: USE_MULTITENANT_SERVER without pgspider_core_fdw extension created
--Testcase 35:
DROP EXTENSION pgspider_core_fdw CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to server pgspider_core_srv
drop cascades to user mapping for public on server pgspider_core_srv
--Testcase 36:
MIGRATE TABLE test_error TO test_error2 OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2;
ERROR:  foreign-data wrapper "pgspider_core_fdw" does not exist
--Testcase 37:
CREATE EXTENSION pgspider_core_fdw;
--Testcase 38:
CREATE SERVER pgspider_core_srv FOREIGN DATA WRAPPER pgspider_core_fdw;
--Testcase 39:
CREATE USER MAPPING FOR public SERVER pgspider_core_srv;
-- ERROR USE_MULTITENANT_SERVER with postgres server
--Testcase 40:
MIGRATE TABLE test_error TO test_error2 OPTIONS (USE_MULTITENANT_SERVER 'postgres_srv1') SERVER postgres_srv2;
ERROR:  PGSpider: postgres_srv1 is not a multitenant server.
-- ERROR: Does not exist dest table option
--Testcase 41:
MIGRATE TABLE test_error TO test_error2 OPTIONS (not_existed_option 'value') SERVER postgres_srv2;
ERROR:  PGSpider: unexpected option: not_existed_option
-- ERROR: Duplicate server specification, same datasource table will create in one server.
--Testcase 42:
MIGRATE TABLE test_error SERVER postgres_srv2, postgres_srv2;
ERROR:  relation "test_error" already exists
CONTEXT:  remote SQL command: CREATE TABLE public.test_error (c1 integer NOT NULL, c2 integer NOT NULL, c3 text COLLATE "default", c4 timestamp with time zone, c5 timestamp without time zone, c6 character varying(10) COLLATE "default", c7 character(10) COLLATE "default");
--Testcase 43:
MIGRATE TABLE test_error TO test_error2 SERVER postgres_srv2 OPTIONS(table_name 'test_error_datasource'), postgres_srv2 OPTIONS(table_name 'test_error_datasource');
ERROR:  relation "test_error_datasource" already exists
CONTEXT:  remote SQL command: CREATE TABLE public.test_error_datasource (c1 integer NOT NULL, c2 integer NOT NULL, c3 text COLLATE "default", c4 timestamp with time zone, c5 timestamp without time zone, c6 character varying(10) COLLATE "default", c7 character(10) COLLATE "default");
-- OK: Same server, different options
--Testcase 44:
MIGRATE TABLE test_error TO test_error2 SERVER postgres_srv2, postgres_srv2 OPTIONS(table_name 'test_error_2'); -- OK
--Testcase 45:
\det+
                                                 List of foreign tables
 Schema |             Table             |      Server       |                 FDW options                  | Description 
--------+-------------------------------+-------------------+----------------------------------------------+-------------
 public | test_error                    | postgres_srv1     | (schema_name 'S 1', table_name 'test_error') | 
 public | test_error2                   | pgspider_core_svr |                                              | 
 public | test_error2__postgres_srv2__0 | postgres_srv2     | (table_name 'test_error')                    | 
 public | test_error2__postgres_srv2__1 | postgres_srv2     | (table_name 'test_error_2')                  | 
(4 rows)

--Testcase 46:
SELECT * FROM test_error2;
 c1 | c2 | c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-----+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | foo | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
(1 row)

--Testcase 47:
DROP DATASOURCE TABLE test_error2__postgres_srv2__0;
--Testcase 48:
DROP DATASOURCE TABLE test_error2__postgres_srv2__1;
--Testcase 49:
DROP FOREIGN TABLE test_error2__postgres_srv2__0;
--Testcase 50:
DROP FOREIGN TABLE test_error2__postgres_srv2__1;
--Testcase 51:
DROP FOREIGN TABLE test_error2;
-- CREATE DATASOURCE TABLE with unsupported FDWs
--Testcase 52:
CREATE EXTENSION file_fdw;
--Testcase 53:
CREATE SERVER file_svr FOREIGN DATA WRAPPER file_fdw;
--Testcase 54:
CREATE FOREIGN TABLE file_tbl (i int) SERVER file_svr options(filename '/tmp/pgtest.csv');
--Testcase 55:
CREATE DATASOURCE TABLE file_tbl;
ERROR:  file_fdw does not support DDL commands
--Testcase 56:
DROP EXTENSION file_fdw CASCADE;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to server file_svr
drop cascades to foreign table file_tbl
-- CREATE DATASOURCE TABLE with postgres normal table
--Testcase 57:
CREATE TABLE post_tbl (i int);
--Testcase 58:
CREATE DATASOURCE TABLE post_tbl;
ERROR:  CREATE DATASOURCE TABLE command support only for FOREIGN TABLE
--Testcase 59:
DROP TABLE post_tbl;
-- clean-up
--Testcase 60:
DROP DATASOURCE TABLE test_error;
--Testcase 61:
DROP FOREIGN TABLE test_error;
----------------------------------------------------------
-- source structure tbl1
-- postgres normal table
----------------------------------------------------------
--Testcase 62:
CREATE PROCEDURE base_table_init()
LANGUAGE SQL
AS $$
    CREATE TABLE IF NOT EXISTS base_table (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'base_table'
    );
$$;
--Testcase 63:
CALL base_table_init();
-- Init data
--Testcase 64:
INSERT INTO base_table
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 15) id;
--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 65:
CREATE FOREIGN TABLE base_table_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'base_table'
) SERVER postgres_srv1 OPTIONS (table_name 'base_table');
-- ERROR: datasource table does not create yet
--Testcase 66:
SELECT * FROM base_table_datasource ORDER BY c1;
ERROR:  relation "public.base_table" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.base_table ORDER BY c1 ASC NULLS LAST
--Testcase 67:
MIGRATE TABLE base_table SERVER postgres_srv1;
-- no new foreign table created
--Testcase 68:
\det+
                                  List of foreign tables
 Schema |         Table         |    Server     |        FDW options        | Description 
--------+-----------------------+---------------+---------------------------+-------------
 public | base_table_datasource | postgres_srv1 | (table_name 'base_table') | 
(1 row)

-- OK: datasource table created
--Testcase 69:
SELECT * FROM base_table_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

-- clean-up
--Testcase 70:
DROP DATASOURCE TABLE base_table_datasource;
--Testcase 71:
DROP FOREIGN TABLE base_table_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 72:
CREATE FOREIGN TABLE base_table_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'base_table'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'base_table');
-- ERROR: datasource table does not create yet
--Testcase 73:
SELECT * FROM base_table_datasource ORDER BY c1;
ERROR:  relation "S 2.base_table" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".base_table ORDER BY c1 ASC NULLS LAST
--Testcase 74:
MIGRATE TABLE base_table SERVER postgres_srv2 OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 75:
\det+
                                           List of foreign tables
 Schema |         Table         |    Server     |                 FDW options                  | Description 
--------+-----------------------+---------------+----------------------------------------------+-------------
 public | base_table_datasource | postgres_srv2 | (schema_name 'S 2', table_name 'base_table') | 
(1 row)

-- OK: datasource table created
--Testcase 76:
SELECT * FROM base_table_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

-- clean-up
--Testcase 77:
DROP DATASOURCE TABLE base_table_datasource;
--Testcase 78:
DROP FOREIGN TABLE base_table_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 79:
CREATE FOREIGN TABLE base_table_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'base_table'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'base_table');
--Testcase 80:
CREATE FOREIGN TABLE base_table_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'base_table'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'base_table');
-- ERROR: datasource table does not create yet
--Testcase 81:
SELECT * FROM base_table_datasource1 ORDER BY c1;
ERROR:  relation "S 1.base_table" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".base_table ORDER BY c1 ASC NULLS LAST
--Testcase 82:
SELECT * FROM base_table_datasource2 ORDER BY c1;
ERROR:  relation "S 1.base_table" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".base_table ORDER BY c1 ASC NULLS LAST
--Testcase 83:
MIGRATE TABLE base_table SERVER postgres_srv2 OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 84:
\det+
                                            List of foreign tables
 Schema |         Table          |    Server     |                 FDW options                  | Description 
--------+------------------------+---------------+----------------------------------------------+-------------
 public | base_table_datasource1 | postgres_srv2 | (schema_name 'S 1', table_name 'base_table') | 
 public | base_table_datasource2 | postgres_srv3 | (schema_name 'S 1', table_name 'base_table') | 
(2 rows)

-- OK: datasource table created
SELECT * FROM base_table ORDER BY c1, __spd_url;
ERROR:  column "__spd_url" does not exist
LINE 1: SELECT * FROM base_table ORDER BY c1, __spd_url;
                                              ^
--Testcase 85:
SELECT count(*) FROM base_table_datasource1;
 count 
-------
     8
(1 row)

--Testcase 86:
SELECT count(*) FROM base_table_datasource2;
 count 
-------
     7
(1 row)

-- clean-up
--Testcase 87:
DROP DATASOURCE TABLE base_table_datasource1;
--Testcase 88:
DROP DATASOURCE TABLE base_table_datasource2;
--Testcase 89:
DROP FOREIGN TABLE base_table_datasource1;
--Testcase 90:
DROP FOREIGN TABLE base_table_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 91:
SELECT * FROM base_table ORDER BY c1, __spd_url;
ERROR:  column "__spd_url" does not exist
LINE 1: SELECT * FROM base_table ORDER BY c1, __spd_url;
                                              ^
--Testcase 92:
MIGRATE TABLE base_table REPLACE SERVER postgres_srv2;
-- base_table is replace by a foreign table
--Testcase 93:
\det+
                            List of foreign tables
 Schema |   Table    |    Server     |        FDW options        | Description 
--------+------------+---------------+---------------------------+-------------
 public | base_table | postgres_srv2 | (table_name 'base_table') | 
(1 row)

-- base_table is postgres foreign table now.
--Testcase 94:
\d base_table
                          Foreign table "public.base_table"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'base_table')

--Testcase 95:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 96:
DROP DATASOURCE TABLE base_table;
--Testcase 97:
DROP FOREIGN TABLE base_table;
-- re-init base_table to execute test after
--Testcase 98:
CALL base_table_init();
-- Init data
--Testcase 99:
INSERT INTO base_table
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 15) id;
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 100:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 101:
MIGRATE TABLE base_table REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- base_table is replace by a new foreign table
--Testcase 102:
\det+
                                  List of foreign tables
 Schema |   Table    |    Server     |              FDW options              | Description 
--------+------------+---------------+---------------------------------------+-------------
 public | base_table | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- base_table is postgres foreign table now.
--Testcase 103:
\d base_table
                          Foreign table "public.base_table"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 104:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 105:
DROP DATASOURCE TABLE base_table;
--Testcase 106:
DROP FOREIGN TABLE base_table;
-- re-init base_table to execute test after
--Testcase 107:
CALL base_table_init();
-- Init data
--Testcase 108:
INSERT INTO base_table
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 15) id;
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 109:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 110:
MIGRATE TABLE base_table REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- base_table is replace by a new multitenant table
--Testcase 111:
\det+
                                             List of foreign tables
 Schema |            Table             |      Server       |              FDW options              | Description 
--------+------------------------------+-------------------+---------------------------------------+-------------
 public | base_table                   | pgspider_core_svr |                                       | 
 public | base_table__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | base_table__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- base_table is multitenant table
--Testcase 112:
\d base_table
                           Foreign table "public.base_table"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 113:
SELECT * FROM base_table ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 114:
SELECT count(*) FROM base_table__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 115:
SELECT count(*) FROM base_table__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 116:
DROP FOREIGN TABLE base_table;
--Testcase 117:
DROP DATASOURCE TABLE base_table__postgres_srv2__0;
--Testcase 118:
DROP DATASOURCE TABLE base_table__postgres_srv3__0;
--Testcase 119:
DROP FOREIGN TABLE base_table__postgres_srv2__0;
--Testcase 120:
DROP FOREIGN TABLE base_table__postgres_srv3__0;
-- re-init base_table to execute test after
--Testcase 121:
CALL base_table_init();
-- Init data
--Testcase 122:
INSERT INTO base_table
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 15) id;
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 123:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 124:
MIGRATE TABLE base_table TO base_table_new SERVER postgres_srv2;
-- new foreign table created
--Testcase 125:
\det+
                              List of foreign tables
 Schema |     Table      |    Server     |        FDW options        | Description 
--------+----------------+---------------+---------------------------+-------------
 public | base_table_new | postgres_srv2 | (table_name 'base_table') | 
(1 row)

-- base_table_new is postgres foreign table
--Testcase 126:
\d base_table_new
                        Foreign table "public.base_table_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'base_table')

--Testcase 127:
SELECT * FROM base_table_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 128:
DROP DATASOURCE TABLE base_table_new;
--Testcase 129:
DROP FOREIGN TABLE base_table_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 130:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 131:
MIGRATE TABLE base_table TO base_table_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreing table created
--Testcase 132:
\det+
                                    List of foreign tables
 Schema |     Table      |    Server     |              FDW options              | Description 
--------+----------------+---------------+---------------------------------------+-------------
 public | base_table_new | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- base_table_new is postgres foreign table
--Testcase 133:
\d base_table_new
                        Foreign table "public.base_table_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 134:
SELECT * FROM base_table_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 135:
DROP DATASOURCE TABLE base_table_new;
--Testcase 136:
DROP FOREIGN TABLE base_table_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 137:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 138:
MIGRATE TABLE base_table TO base_table_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 139:
\det+
                                               List of foreign tables
 Schema |              Table               |      Server       |              FDW options              | Description 
--------+----------------------------------+-------------------+---------------------------------------+-------------
 public | base_table_new                   | pgspider_core_svr |                                       | 
 public | base_table_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | base_table_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2') | 
(3 rows)

-- base_table_new is multitenant table
--Testcase 140:
\d base_table_new
                         Foreign table "public.base_table_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 141:
SELECT * FROM base_table_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 142:
SELECT count(*) FROM base_table_new__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 143:
SELECT count(*) FROM base_table_new__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 144:
DROP FOREIGN TABLE base_table_new;
--Testcase 145:
DROP DATASOURCE TABLE base_table_new__postgres_srv2__0;
--Testcase 146:
DROP DATASOURCE TABLE base_table_new__postgres_srv3__0;
--Testcase 147:
DROP FOREIGN TABLE base_table_new__postgres_srv2__0;
--Testcase 148:
DROP FOREIGN TABLE base_table_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 149:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 150:
MIGRATE TABLE base_table TO base_table_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2;
-- new multitenant table created
--Testcase 151:
\det+
                                         List of foreign tables
 Schema |              Table               |      Server       |        FDW options        | Description 
--------+----------------------------------+-------------------+---------------------------+-------------
 public | base_table_new                   | pgspider_core_svr |                           | 
 public | base_table_new__postgres_srv2__0 | postgres_srv2     | (table_name 'base_table') | 
(2 rows)

-- base_table_new is multitenant table
--Testcase 152:
\d base_table_new
                         Foreign table "public.base_table_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 153:
SELECT * FROM base_table_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 154:
SELECT * FROM base_table_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 155:
DROP FOREIGN TABLE base_table_new;
--Testcase 156:
DROP DATASOURCE TABLE base_table_new__postgres_srv2__0;
--Testcase 157:
DROP FOREIGN TABLE base_table_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 158:
SELECT * FROM base_table ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 159:
MIGRATE TABLE base_table TO base_table_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 160:
\det+
                                               List of foreign tables
 Schema |              Table               |      Server       |              FDW options              | Description 
--------+----------------------------------+-------------------+---------------------------------------+-------------
 public | base_table_new                   | pgspider_core_svr |                                       | 
 public | base_table_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(2 rows)

-- base_table_new is multitenant table
--Testcase 161:
\d base_table_new
                         Foreign table "public.base_table_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 162:
SELECT * FROM base_table_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 163:
SELECT * FROM base_table_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 164:
DROP FOREIGN TABLE base_table_new;
--Testcase 165:
DROP DATASOURCE TABLE base_table_new__postgres_srv2__0;
--Testcase 166:
DROP FOREIGN TABLE base_table_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 167:
MIGRATE TABLE base_table TO base_table_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 168:
\det+
                                               List of foreign tables
 Schema |              Table               |      Server       |              FDW options              | Description 
--------+----------------------------------+-------------------+---------------------------------------+-------------
 public | base_table_new                   | pgspider_core_svr |                                       | 
 public | base_table_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | base_table_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- base_table_new is multitenant table
--Testcase 169:
\d base_table_new
                         Foreign table "public.base_table_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 170:
SELECT * FROM base_table_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 171:
SELECT count(*) FROM base_table_new__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 172:
SELECT count(*) FROM base_table_new__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 173:
DROP FOREIGN TABLE base_table_new;
--Testcase 174:
DROP DATASOURCE TABLE base_table_new__postgres_srv2__0;
--Testcase 175:
DROP DATASOURCE TABLE base_table_new__postgres_srv3__0;
--Testcase 176:
DROP FOREIGN TABLE base_table_new__postgres_srv2__0;
--Testcase 177:
DROP FOREIGN TABLE base_table_new__postgres_srv3__0;
-- clean-up
--Testcase 178:
DROP TABLE base_table;
----------------------------------------------------------
-- source structure tbl1
-- PGSpider Top Node -> 3 posgres data source
----------------------------------------------------------
--Testcase 179:
CREATE PROCEDURE tbl1_init()
LANGUAGE SQL
AS $$
    CREATE FOREIGN TABLE IF NOT EXISTS tbl1 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1',
        __spd_url text
    ) SERVER pgspider_core_srv;

--Testcase 180:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl1__postgres_srv1__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1'
    ) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'T 1');
--Testcase 181:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl1__postgres_srv1__0;

--Testcase 182:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl1__postgres_srv2__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1'
    ) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'T 1');
--Testcase 183:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl1__postgres_srv2__0;

--Testcase 184:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl1__postgres_srv3__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1'
    ) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'T 1');
--Testcase 185:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl1__postgres_srv3__0;
$$;
--Testcase 186:
CALL tbl1_init();
-- Init data
--Testcase 187:
INSERT INTO tbl1__postgres_srv1__0
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 5) id;
--Testcase 188:
INSERT INTO tbl1__postgres_srv2__0
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(6, 10) id;
--Testcase 189:
INSERT INTO tbl1__postgres_srv3__0
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(11, 15) id;
--Testcase 190:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 191:
CREATE FOREIGN TABLE tbl1_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv1 OPTIONS (table_name 'tbl1');
-- ERROR: datasource table does not create yet
--Testcase 192:
SELECT * FROM tbl1_datasource ORDER BY c1;
ERROR:  relation "public.tbl1" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.tbl1 ORDER BY c1 ASC NULLS LAST
--Testcase 193:
MIGRATE TABLE tbl1 SERVER postgres_srv1;
-- no new foreign table created
--Testcase 194:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1_datasource        | postgres_srv1     | (table_name 'tbl1')                   | 
(5 rows)

-- OK: datasource table created
--Testcase 195:
SELECT * FROM tbl1_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

-- clean-up
--Testcase 196:
DROP DATASOURCE TABLE tbl1_datasource;
--Testcase 197:
DROP FOREIGN TABLE tbl1_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 198:
CREATE FOREIGN TABLE tbl1_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'tbl1');
-- ERROR: datasource table does not create yet
--Testcase 199:
SELECT * FROM tbl1_datasource ORDER BY c1;
ERROR:  relation "S 2.tbl1" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".tbl1 ORDER BY c1 ASC NULLS LAST
--Testcase 200:
MIGRATE TABLE tbl1 SERVER postgres_srv2 OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 201:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                        | 
 public | tbl1__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1_datasource        | postgres_srv2     | (schema_name 'S 2', table_name 'tbl1') | 
(5 rows)

-- OK: datasource table created
--Testcase 202:
SELECT * FROM tbl1_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

-- clean-up
--Testcase 203:
DROP DATASOURCE TABLE tbl1_datasource;
--Testcase 204:
DROP FOREIGN TABLE tbl1_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 205:
CREATE FOREIGN TABLE tbl1_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'tbl1');
--Testcase 206:
CREATE FOREIGN TABLE tbl1_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl1'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'tbl1');
-- ERROR: datasource table does not create yet
--Testcase 207:
SELECT * FROM tbl1_datasource1 ORDER BY c1;
ERROR:  relation "S 1.tbl1" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl1 ORDER BY c1 ASC NULLS LAST
--Testcase 208:
SELECT * FROM tbl1_datasource2 ORDER BY c1;
ERROR:  relation "S 1.tbl1" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl1 ORDER BY c1 ASC NULLS LAST
--Testcase 209:
MIGRATE TABLE tbl1 SERVER postgres_srv2 OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 210:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                        | 
 public | tbl1__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1_datasource1       | postgres_srv2     | (schema_name 'S 1', table_name 'tbl1') | 
 public | tbl1_datasource2       | postgres_srv3     | (schema_name 'S 1', table_name 'tbl1') | 
(6 rows)

-- OK: datasource table created
SELECT * FROM tbl1 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 211:
SELECT count(*) FROM tbl1_datasource1;
 count 
-------
     8
(1 row)

--Testcase 212:
SELECT count(*) FROM tbl1_datasource2;
 count 
-------
     7
(1 row)

-- clean-up
--Testcase 213:
DROP DATASOURCE TABLE tbl1_datasource1;
--Testcase 214:
DROP DATASOURCE TABLE tbl1_datasource2;
--Testcase 215:
DROP FOREIGN TABLE tbl1_datasource1;
--Testcase 216:
DROP FOREIGN TABLE tbl1_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 217:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 218:
MIGRATE TABLE tbl1 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 1');
-- show datasource table and foreign table
--Testcase 219:
SELECT table_schema, table_name, table_type FROM information_schema.tables
	WHERE table_type in ('BASE TABLE', 'FOREIGN') AND table_schema NOT IN ('pg_catalog', 'information_schema');
 table_schema | table_name | table_type 
--------------+------------+------------
 public       | tbl1       | FOREIGN
(1 row)

-- tbl1 is postgres foreign table now.
--Testcase 220:
\d tbl1
                             Foreign table "public.tbl1"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 1', table_name 'tbl1')

--Testcase 221:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 222:
DROP DATASOURCE TABLE tbl1;
--Testcase 223:
DROP FOREIGN TABLE tbl1;
-- re-init tbl1 to execute test after
--Testcase 224:
CALL tbl1_init();
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 225:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 226:
MIGRATE TABLE tbl1 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- tbl1 is replaced by a new foreign table
--Testcase 227:
\det+
                                List of foreign tables
 Schema | Table |    Server     |              FDW options              | Description 
--------+-------+---------------+---------------------------------------+-------------
 public | tbl1  | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- tbl1 is postgres foreign table now.
--Testcase 228:
\d tbl1
                             Foreign table "public.tbl1"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 229:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 230:
DROP DATASOURCE TABLE tbl1;
--Testcase 231:
DROP FOREIGN TABLE tbl1;
-- re-init tbl1 to execute test after
--Testcase 232:
CALL tbl1_init();
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 233:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 234:
MIGRATE TABLE tbl1 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- tbl1 is replaced by a new foreign table
--Testcase 235:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- tbl1 is multitenant table
--Testcase 236:
\d tbl1
                              Foreign table "public.tbl1"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 237:
SELECT * FROM tbl1 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 238:
SELECT count(*) FROM tbl1__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 239:
SELECT count(*) FROM tbl1__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 240:
DROP FOREIGN TABLE tbl1;
--Testcase 241:
DROP DATASOURCE TABLE tbl1__postgres_srv2__0;
--Testcase 242:
DROP DATASOURCE TABLE tbl1__postgres_srv3__0;
--Testcase 243:
DROP FOREIGN TABLE tbl1__postgres_srv2__0;
--Testcase 244:
DROP FOREIGN TABLE tbl1__postgres_srv3__0;
-- re-init tbl1 to execute test after
--Testcase 245:
CALL tbl1_init();
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 246:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 247:
MIGRATE TABLE tbl1 TO tbl1_new SERVER postgres_srv2 OPTIONS(schema_name 'S 1');
-- new foreign table created
--Testcase 248:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                        | 
 public | tbl1__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1_new               | postgres_srv2     | (schema_name 'S 1', table_name 'tbl1') | 
(5 rows)

-- tbl1_new is postgres foreign table
--Testcase 249:
\d tbl1_new
                           Foreign table "public.tbl1_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 1', table_name 'tbl1')

--Testcase 250:
SELECT * FROM tbl1_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 251:
DROP DATASOURCE TABLE tbl1_new;
--Testcase 252:
DROP FOREIGN TABLE tbl1_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 253:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 254:
MIGRATE TABLE tbl1 TO tbl1_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 255:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                   | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1_new               | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(5 rows)

-- tbl1_new is postgres foreign table
--Testcase 256:
\d tbl1_new
                           Foreign table "public.tbl1_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 257:
SELECT * FROM tbl1_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 258:
DROP DATASOURCE TABLE tbl1_new;
--Testcase 259:
DROP FOREIGN TABLE tbl1_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 260:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 261:
MIGRATE TABLE tbl1 TO tbl1_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 262:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                       | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv3__0     | postgres_srv3     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1_new                   | pgspider_core_srv |                                       | 
 public | tbl1_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl1_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2') | 
(7 rows)

-- tbl1_new is multitenant table
--Testcase 263:
\d tbl1_new
                            Foreign table "public.tbl1_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 264:
SELECT * FROM tbl1_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv3/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv3/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv3/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv3/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 265:
SELECT count(*) FROM tbl1_new__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 266:
SELECT count(*) FROM tbl1_new__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 267:
DROP FOREIGN TABLE tbl1_new;
--Testcase 268:
DROP DATASOURCE TABLE tbl1_new__postgres_srv2__0;
--Testcase 269:
DROP DATASOURCE TABLE tbl1_new__postgres_srv3__0;
--Testcase 270:
DROP FOREIGN TABLE tbl1_new__postgres_srv2__0;
--Testcase 271:
DROP FOREIGN TABLE tbl1_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 272:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 273:
MIGRATE TABLE tbl1 TO tbl1_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 1');
-- new multitenant table created
--Testcase 274:
\det+
                                             List of foreign tables
 Schema |           Table            |      Server       |              FDW options               | Description 
--------+----------------------------+-------------------+----------------------------------------+-------------
 public | tbl1                       | pgspider_core_srv |                                        | 
 public | tbl1__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1__postgres_srv3__0     | postgres_srv3     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl1_new                   | pgspider_core_svr |                                        | 
 public | tbl1_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'tbl1') | 
(6 rows)

-- tbl1_new is multitenant table
--Testcase 275:
\d tbl1_new
                            Foreign table "public.tbl1_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 276:
SELECT * FROM tbl1_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 277:
SELECT * FROM tbl1_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 278:
DROP FOREIGN TABLE tbl1_new;
--Testcase 279:
DROP DATASOURCE TABLE tbl1_new__postgres_srv2__0;
--Testcase 280:
DROP FOREIGN TABLE tbl1_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 281:
SELECT * FROM tbl1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv3/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv3/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv3/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv3/
(15 rows)

--Testcase 282:
MIGRATE TABLE tbl1 TO tbl1_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitennant table created
--Testcase 283:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                       | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv3__0     | postgres_srv3     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1_new                   | pgspider_core_svr |                                       | 
 public | tbl1_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(6 rows)

-- tbl1_new is multitenant table
--Testcase 284:
\d tbl1_new
                            Foreign table "public.tbl1_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 285:
SELECT * FROM tbl1_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv2/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 286:
SELECT * FROM tbl1_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1         
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2         
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3         
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4         
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5         
(15 rows)

--Testcase 287:
DROP FOREIGN TABLE tbl1_new;
--Testcase 288:
DROP DATASOURCE TABLE tbl1_new__postgres_srv2__0;
--Testcase 289:
DROP FOREIGN TABLE tbl1_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 290:
MIGRATE TABLE tbl1 TO tbl1_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitennant table created
--Testcase 291:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl1                       | pgspider_core_srv |                                       | 
 public | tbl1__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1__postgres_srv3__0     | postgres_srv3     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl1_new                   | pgspider_core_svr |                                       | 
 public | tbl1_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl1_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(7 rows)

-- tbl1_new is multitenant table
--Testcase 292:
\d tbl1_new
                            Foreign table "public.tbl1_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 293:
SELECT * FROM tbl1_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv3/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
 11 |  1 | 00011 | Mon Jan 12 00:00:00 1970 PST | Mon Jan 12 00:00:00 1970 | 1  | 1          | /postgres_srv2/
 12 |  2 | 00012 | Tue Jan 13 00:00:00 1970 PST | Tue Jan 13 00:00:00 1970 | 2  | 2          | /postgres_srv2/
 13 |  3 | 00013 | Wed Jan 14 00:00:00 1970 PST | Wed Jan 14 00:00:00 1970 | 3  | 3          | /postgres_srv2/
 14 |  4 | 00014 | Thu Jan 15 00:00:00 1970 PST | Thu Jan 15 00:00:00 1970 | 4  | 4          | /postgres_srv3/
 15 |  5 | 00015 | Fri Jan 16 00:00:00 1970 PST | Fri Jan 16 00:00:00 1970 | 5  | 5          | /postgres_srv2/
(15 rows)

-- check data distribution
--Testcase 294:
SELECT count(*) FROM tbl1_new__postgres_srv2__0;
 count 
-------
     8
(1 row)

--Testcase 295:
SELECT count(*) FROM tbl1_new__postgres_srv3__0;
 count 
-------
     7
(1 row)

--Testcase 296:
DROP FOREIGN TABLE tbl1_new;
--Testcase 297:
DROP DATASOURCE TABLE tbl1_new__postgres_srv2__0;
--Testcase 298:
DROP DATASOURCE TABLE tbl1_new__postgres_srv3__0;
--Testcase 299:
DROP FOREIGN TABLE tbl1_new__postgres_srv2__0;
--Testcase 300:
DROP FOREIGN TABLE tbl1_new__postgres_srv3__0;
-- clean-up
--Testcase 301:
DROP DATASOURCE TABLE tbl1__postgres_srv1__0;
--Testcase 302:
DROP DATASOURCE TABLE tbl1__postgres_srv2__0;
--Testcase 303:
DROP DATASOURCE TABLE tbl1__postgres_srv3__0;
--Testcase 304:
DROP FOREIGN TABLE tbl1__postgres_srv1__0;
--Testcase 305:
DROP FOREIGN TABLE tbl1__postgres_srv2__0;
--Testcase 306:
DROP FOREIGN TABLE tbl1__postgres_srv3__0;
--Testcase 307:
DROP FOREIGN TABLE tbl1;
----------------------------------------------------------
-- end testing for source structure tbl1
-- PGSpider Top Node -> 3 posgres data source
----------------------------------------------------------
----------------------------------------------------------
-- source structure tbl2
-- PGSpider Top Node -> pgspider_core_fdw -> PGSpider -> pgspider_core_fdw -> Postgres child node
----------------------------------------------------------
--Testcase 308:
CREATE PROCEDURE tbl2_init()
LANGUAGE SQL
AS $$
CREATE FOREIGN TABLE tbl2 (
	c1 int NOT NULL,
	c2 int NOT NULL,
	c3 text,
	c4 timestamptz,
	c5 timestamp,
	c6 varchar(10),
	c7 char(10) default 'tbl2',
	__spd_url text
) SERVER pgspider_core_srv;

--Testcase 309:
CREATE FOREIGN TABLE tbl2__pgspider_srv1__0 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl2_0',
    __spd_url text
) SERVER pgspider_srv1 OPTIONS (table_name 'tbl2');
$$;
--Testcase 310:
CALL tbl2_init();
--Testcase 311:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 312:
CREATE FOREIGN TABLE tbl2_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl2'
) SERVER postgres_srv1 OPTIONS (table_name 'tbl2');
-- ERROR: datasource table does not create yet
--Testcase 313:
SELECT * FROM tbl2_datasource ORDER BY c1;
ERROR:  relation "public.tbl2" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.tbl2 ORDER BY c1 ASC NULLS LAST
--Testcase 314:
MIGRATE TABLE tbl2 SERVER postgres_srv1;
-- no new foreign table created
--Testcase 315:
\det+
                                 List of foreign tables
 Schema |         Table          |      Server       |     FDW options     | Description 
--------+------------------------+-------------------+---------------------+-------------
 public | tbl2                   | pgspider_core_srv |                     | 
 public | tbl2__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl2') | 
 public | tbl2_datasource        | postgres_srv1     | (table_name 'tbl2') | 
(3 rows)

-- OK: datasource table created
--Testcase 316:
SELECT * FROM tbl2_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 317:
DROP DATASOURCE TABLE tbl2_datasource;
--Testcase 318:
DROP FOREIGN TABLE tbl2_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 319:
CREATE FOREIGN TABLE tbl2_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl2'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'tbl2');
-- ERROR: datasource table does not create yet
--Testcase 320:
SELECT * FROM tbl2_datasource ORDER BY c1;
ERROR:  relation "S 2.tbl2" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".tbl2 ORDER BY c1 ASC NULLS LAST
--Testcase 321:
MIGRATE TABLE tbl2 SERVER postgres_srv2 OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 322:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl2                   | pgspider_core_srv |                                        | 
 public | tbl2__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl2')                    | 
 public | tbl2_datasource        | postgres_srv2     | (schema_name 'S 2', table_name 'tbl2') | 
(3 rows)

-- OK: datasource table created
--Testcase 323:
SELECT * FROM tbl2_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 324:
DROP DATASOURCE TABLE tbl2_datasource;
--Testcase 325:
DROP FOREIGN TABLE tbl2_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 326:
CREATE FOREIGN TABLE tbl2_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl2'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'tbl2');
--Testcase 327:
CREATE FOREIGN TABLE tbl2_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl2'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'tbl2');
-- ERROR: datasource table does not create yet
--Testcase 328:
SELECT * FROM tbl2_datasource1 ORDER BY c1;
ERROR:  relation "S 1.tbl2" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl2 ORDER BY c1 ASC NULLS LAST
--Testcase 329:
SELECT * FROM tbl2_datasource2 ORDER BY c1;
ERROR:  relation "S 1.tbl2" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl2 ORDER BY c1 ASC NULLS LAST
--Testcase 330:
MIGRATE TABLE tbl2 SERVER postgres_srv2 OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 331:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl2                   | pgspider_core_srv |                                        | 
 public | tbl2__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl2')                    | 
 public | tbl2_datasource1       | postgres_srv2     | (schema_name 'S 1', table_name 'tbl2') | 
 public | tbl2_datasource2       | postgres_srv3     | (schema_name 'S 1', table_name 'tbl2') | 
(4 rows)

-- OK: datasource table created
SELECT * FROM tbl2 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 332:
SELECT count(*) FROM tbl2_datasource1;
 count 
-------
     5
(1 row)

--Testcase 333:
SELECT count(*) FROM tbl2_datasource2;
 count 
-------
     5
(1 row)

-- clean-up
--Testcase 334:
DROP DATASOURCE TABLE tbl2_datasource1;
--Testcase 335:
DROP DATASOURCE TABLE tbl2_datasource2;
--Testcase 336:
DROP FOREIGN TABLE tbl2_datasource1;
--Testcase 337:
DROP FOREIGN TABLE tbl2_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 338:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 339:
MIGRATE TABLE tbl2 REPLACE SERVER postgres_srv2;
-- tbl2 is replace by a foreign table
--Testcase 340:
\det+
                       List of foreign tables
 Schema | Table |    Server     |     FDW options     | Description 
--------+-------+---------------+---------------------+-------------
 public | tbl2  | postgres_srv2 | (table_name 'tbl2') | 
(1 row)

-- tbl2 is postgres foreign table now.
--Testcase 341:
\d tbl2
                             Foreign table "public.tbl2"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'tbl2')

--Testcase 342:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 343:
DROP DATASOURCE TABLE tbl2;
--Testcase 344:
DROP FOREIGN TABLE tbl2;
-- re-init tbl2 to execute test after
--Testcase 345:
CALL tbl2_init();
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 346:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 347:
MIGRATE TABLE tbl2 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- tbl2 is replace by a foreign table
--Testcase 348:
\det+
                                List of foreign tables
 Schema | Table |    Server     |              FDW options              | Description 
--------+-------+---------------+---------------------------------------+-------------
 public | tbl2  | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- tbl2 is postgres foreign table now.
--Testcase 349:
\d tbl2
                             Foreign table "public.tbl2"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 350:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 351:
DROP DATASOURCE TABLE tbl2;
--Testcase 352:
DROP FOREIGN TABLE tbl2;
-- re-init tbl2 to execute test after
--Testcase 353:
CALL tbl2_init();
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 354:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 355:
MIGRATE TABLE tbl2 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- tbl2 is replace by a multitenant table
--Testcase 356:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl2                   | pgspider_core_srv |                                       | 
 public | tbl2__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl2__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- tbl2 is multitenant table
--Testcase 357:
\d tbl2
                              Foreign table "public.tbl2"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 358:
SELECT * FROM tbl2 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 359:
SELECT count(*) FROM tbl2__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 360:
SELECT count(*) FROM tbl2__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 361:
DROP FOREIGN TABLE tbl2;
--Testcase 362:
DROP DATASOURCE TABLE tbl2__postgres_srv2__0;
--Testcase 363:
DROP DATASOURCE TABLE tbl2__postgres_srv3__0;
--Testcase 364:
DROP FOREIGN TABLE tbl2__postgres_srv2__0;
--Testcase 365:
DROP FOREIGN TABLE tbl2__postgres_srv3__0;
-- re-init tbl2 to execute test after
--Testcase 366:
CALL tbl2_init();
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 367:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 368:
MIGRATE TABLE tbl2 TO tbl2_new SERVER postgres_srv2;
-- new foreign table created
--Testcase 369:
\det+
                                 List of foreign tables
 Schema |         Table          |      Server       |     FDW options     | Description 
--------+------------------------+-------------------+---------------------+-------------
 public | tbl2                   | pgspider_core_srv |                     | 
 public | tbl2__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl2') | 
 public | tbl2_new               | postgres_srv2     | (table_name 'tbl2') | 
(3 rows)

-- tbl2_new is postgres foreign table
--Testcase 370:
\d tbl2_new
                           Foreign table "public.tbl2_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'tbl2')

--Testcase 371:
SELECT * FROM tbl2_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 372:
DROP DATASOURCE TABLE tbl2_new;
--Testcase 373:
DROP FOREIGN TABLE tbl2_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 374:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 375:
MIGRATE TABLE tbl2 TO tbl2_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 376:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl2                   | pgspider_core_srv |                                       | 
 public | tbl2__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl2')                   | 
 public | tbl2_new               | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(3 rows)

-- tbl2_new is postgres foreign table
--Testcase 377:
\d tbl2_new
                           Foreign table "public.tbl2_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 378:
SELECT * FROM tbl2_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 379:
DROP DATASOURCE TABLE tbl2_new;
--Testcase 380:
DROP FOREIGN TABLE tbl2_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 381:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 382:
MIGRATE TABLE tbl2 TO tbl2_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 383:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl2                       | pgspider_core_srv |                                       | 
 public | tbl2__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl2')                   | 
 public | tbl2_new                   | pgspider_core_srv |                                       | 
 public | tbl2_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl2_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2') | 
(5 rows)

-- tbl2_new is multitenant table
--Testcase 384:
\d tbl2_new
                            Foreign table "public.tbl2_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 385:
SELECT * FROM tbl2_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 386:
SELECT count(*) FROM tbl2_new__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 387:
SELECT count(*) FROM tbl2_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 388:
DROP FOREIGN TABLE tbl2_new;
--Testcase 389:
DROP DATASOURCE TABLE tbl2_new__postgres_srv2__0;
--Testcase 390:
DROP DATASOURCE TABLE tbl2_new__postgres_srv3__0;
--Testcase 391:
DROP FOREIGN TABLE tbl2_new__postgres_srv2__0;
--Testcase 392:
DROP FOREIGN TABLE tbl2_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 393:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 394:
MIGRATE TABLE tbl2 TO tbl2_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2;
-- new multitenant table created
--Testcase 395:
\det+
                                   List of foreign tables
 Schema |           Table            |      Server       |     FDW options     | Description 
--------+----------------------------+-------------------+---------------------+-------------
 public | tbl2                       | pgspider_core_srv |                     | 
 public | tbl2__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl2') | 
 public | tbl2_new                   | pgspider_core_svr |                     | 
 public | tbl2_new__postgres_srv2__0 | postgres_srv2     | (table_name 'tbl2') | 
(4 rows)

-- tbl2_new is multitenant table
--Testcase 396:
\d tbl2_new
                            Foreign table "public.tbl2_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 397:
SELECT * FROM tbl2_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

-- check data distribution
--Testcase 398:
SELECT * FROM tbl2_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 399:
DROP FOREIGN TABLE tbl2_new;
--Testcase 400:
DROP DATASOURCE TABLE tbl2_new__postgres_srv2__0;
--Testcase 401:
DROP FOREIGN TABLE tbl2_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 402:
SELECT * FROM tbl2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+-------+------------------------------+--------------------------+----+------------+-------------------------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /pgspider_srv1/postgres_srv1/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /pgspider_srv1/postgres_srv1/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /pgspider_srv1/postgres_srv1/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /pgspider_srv1/postgres_srv1/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /pgspider_srv1/postgres_srv1/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /pgspider_srv1/postgres_srv1/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /pgspider_srv1/postgres_srv1/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /pgspider_srv1/postgres_srv1/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /pgspider_srv1/postgres_srv1/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /pgspider_srv1/postgres_srv1/
(10 rows)

--Testcase 403:
MIGRATE TABLE tbl2 TO tbl2_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 404:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl2                       | pgspider_core_srv |                                       | 
 public | tbl2__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl2')                   | 
 public | tbl2_new                   | pgspider_core_svr |                                       | 
 public | tbl2_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(4 rows)

-- tbl2_new is multitenant table
--Testcase 405:
\d tbl2_new
                            Foreign table "public.tbl2_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 406:
SELECT * FROM tbl2_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

-- check data distribution
--Testcase 407:
SELECT * FROM tbl2_new__postgres_srv2__0;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 408:
DROP FOREIGN TABLE tbl2_new;
--Testcase 409:
DROP DATASOURCE TABLE tbl2_new__postgres_srv2__0;
--Testcase 410:
DROP FOREIGN TABLE tbl2_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 411:
MIGRATE TABLE tbl2 TO tbl2_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 412:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl2                       | pgspider_core_srv |                                       | 
 public | tbl2__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl2')                   | 
 public | tbl2_new                   | pgspider_core_svr |                                       | 
 public | tbl2_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl2_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(5 rows)

-- tbl2_new is multitenant table
--Testcase 413:
\d tbl2_new
                            Foreign table "public.tbl2_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 414:
SELECT * FROM tbl2_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Thu Jan 01 16:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Fri Jan 02 16:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sat Jan 03 16:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Sun Jan 04 16:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Mon Jan 05 16:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Tue Jan 06 16:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Wed Jan 07 16:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Thu Jan 08 16:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Fri Jan 09 16:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sat Jan 10 16:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 415:
SELECT count(*) FROM tbl2_new__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 416:
SELECT count(*) FROM tbl2_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 417:
DROP FOREIGN TABLE tbl2_new;
--Testcase 418:
DROP DATASOURCE TABLE tbl2_new__postgres_srv2__0;
--Testcase 419:
DROP DATASOURCE TABLE tbl2_new__postgres_srv3__0;
--Testcase 420:
DROP FOREIGN TABLE tbl2_new__postgres_srv2__0;
--Testcase 421:
DROP FOREIGN TABLE tbl2_new__postgres_srv3__0;
-- clean-up
--Testcase 422:
DROP FOREIGN TABLE tbl2__pgspider_srv1__0;
--Testcase 423:
DROP FOREIGN TABLE tbl2;
----------------------------------------------------------
-- end source structure tbl2
-- PGSpider Top Node -> pgspider_core_fdw -> PGSpider -> pgspider_core_fdw -> Postgres child node
----------------------------------------------------------
----------------------------------------------------------
-- source structure tbl3
-- PGSpider Top Node --|-> Postgres child node
--                     |-> Postgres child node
--                     |-> pgspider_core_fdw -> PGSpider |-> pgspider_core_fdw |-> Postgres child node
--                                                                             |-> Postgres child node
----------------------------------------------------------
--Testcase 424:
CREATE PROCEDURE tbl3_init()
LANGUAGE SQL
AS $$
    CREATE FOREIGN TABLE tbl3 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl2',
        __spd_url text
    ) SERVER pgspider_core_srv;

    -- postgres child node 1
--Testcase 425:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl3__postgres_srv1__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1'
    ) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'T 1');
--Testcase 426:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl3__postgres_srv1__0;

    -- postgres child node 2
--Testcase 427:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl3__postgres_srv2__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl1'
    ) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'T 1');
--Testcase 428:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl3__postgres_srv2__0;

    -- pgspider child node1
--Testcase 429:
    CREATE FOREIGN TABLE tbl3__pgspider_srv1__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl3_0',
        __spd_url text
    ) SERVER pgspider_srv1 OPTIONS (table_name 'tbl3');
$$;
--Testcase 430:
CALL tbl3_init();
-- init postgres note data
--Testcase 431:
INSERT INTO tbl3__postgres_srv1__0 VALUES (0, 0, 'foo', '2022/10/09 12:00:00 +08', '2022/10/09 12:00:00', '0', DEFAULT);
--Testcase 432:
INSERT INTO tbl3__postgres_srv1__0 VALUES (1, 1, 'bar', '2022/10/08 12:00:00 +08', '2022/10/08 12:00:00', '1', DEFAULT);
--Testcase 433:
INSERT INTO tbl3__postgres_srv2__0 VALUES (10, 0, 'foo', '2022/10/06 12:00:00 +08', '2022/10/06 12:00:00', '0', DEFAULT);
--Testcase 434:
INSERT INTO tbl3__postgres_srv2__0 VALUES (11, 1, 'bar', '2022/10/07 12:00:00 +08', '2022/10/07 12:00:00', '1', DEFAULT);
--Testcase 435:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 436:
CREATE FOREIGN TABLE tbl3_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl3'
) SERVER postgres_srv1 OPTIONS (table_name 'tbl3');
-- ERROR: datasource table does not create yet
--Testcase 437:
SELECT * FROM tbl3_datasource ORDER BY c1;
ERROR:  relation "public.tbl3" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.tbl3 ORDER BY c1 ASC NULLS LAST
--Testcase 438:
MIGRATE TABLE tbl3 SERVER postgres_srv1;
-- no new foreign table created
--Testcase 439:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_datasource        | postgres_srv1     | (table_name 'tbl3')                   | 
(5 rows)

-- OK: datasource table created
--Testcase 440:
SELECT * FROM tbl3_datasource ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

-- clean-up
--Testcase 441:
DROP DATASOURCE TABLE tbl3_datasource;
--Testcase 442:
DROP FOREIGN TABLE tbl3_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 443:
CREATE FOREIGN TABLE tbl3_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl3'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'tbl3');
-- ERROR: datasource table does not create yet
--Testcase 444:
SELECT * FROM tbl3_datasource ORDER BY c1;
ERROR:  relation "S 2.tbl3" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".tbl3 ORDER BY c1 ASC NULLS LAST
--Testcase 445:
MIGRATE TABLE tbl3 SERVER postgres_srv2 OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 446:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                        | 
 public | tbl3__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl3')                    | 
 public | tbl3__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl3_datasource        | postgres_srv2     | (schema_name 'S 2', table_name 'tbl3') | 
(5 rows)

-- OK: datasource table created
--Testcase 447:
SELECT * FROM tbl3_datasource ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

-- clean-up
--Testcase 448:
DROP DATASOURCE TABLE tbl3_datasource;
--Testcase 449:
DROP FOREIGN TABLE tbl3_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 450:
CREATE FOREIGN TABLE tbl3_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl3'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'tbl3');
--Testcase 451:
CREATE FOREIGN TABLE tbl3_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl3'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'tbl3');
-- ERROR: datasource table does not create yet
--Testcase 452:
SELECT * FROM tbl3_datasource1 ORDER BY c1;
ERROR:  relation "S 1.tbl3" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl3 ORDER BY c1 ASC NULLS LAST
--Testcase 453:
SELECT * FROM tbl3_datasource2 ORDER BY c1;
ERROR:  relation "S 1.tbl3" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl3 ORDER BY c1 ASC NULLS LAST
--Testcase 454:
MIGRATE TABLE tbl3 SERVER postgres_srv2 OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 455:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                        | 
 public | tbl3__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl3')                    | 
 public | tbl3__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1')  | 
 public | tbl3_datasource1       | postgres_srv2     | (schema_name 'S 1', table_name 'tbl3') | 
 public | tbl3_datasource2       | postgres_srv3     | (schema_name 'S 1', table_name 'tbl3') | 
(6 rows)

-- OK: datasource table created
SELECT * FROM tbl3 ORDER BY c1, __spd_url;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 456:
SELECT count(*) FROM tbl3_datasource1;
 count 
-------
     4
(1 row)

--Testcase 457:
SELECT count(*) FROM tbl3_datasource2;
 count 
-------
     4
(1 row)

-- clean-up
--Testcase 458:
DROP DATASOURCE TABLE tbl3_datasource1;
--Testcase 459:
DROP DATASOURCE TABLE tbl3_datasource2;
--Testcase 460:
DROP FOREIGN TABLE tbl3_datasource1;
--Testcase 461:
DROP FOREIGN TABLE tbl3_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 462:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 463:
MIGRATE TABLE tbl3 REPLACE SERVER postgres_srv2;
-- tbl3 is replaced by a foreign table
--Testcase 464:
\det+
                       List of foreign tables
 Schema | Table |    Server     |     FDW options     | Description 
--------+-------+---------------+---------------------+-------------
 public | tbl3  | postgres_srv2 | (table_name 'tbl3') | 
(1 row)

-- tbl3 is postgres foreign table now.
--Testcase 465:
\d tbl3
                             Foreign table "public.tbl3"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'tbl3')

--Testcase 466:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 467:
DROP DATASOURCE TABLE tbl3;
--Testcase 468:
DROP FOREIGN TABLE tbl3;
-- re-init tbl3 to execute test after
--Testcase 469:
CALL tbl3_init();
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 470:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 471:
MIGRATE TABLE tbl3 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- tbl3 is replaced by a foreign table
--Testcase 472:
\det+
                                List of foreign tables
 Schema | Table |    Server     |              FDW options              | Description 
--------+-------+---------------+---------------------------------------+-------------
 public | tbl3  | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- tbl3 is postgres foreign table now.
--Testcase 473:
\d tbl3
                             Foreign table "public.tbl3"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 474:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 475:
DROP DATASOURCE TABLE tbl3;
--Testcase 476:
DROP FOREIGN TABLE tbl3;
-- re-init tbl3 to execute test after
--Testcase 477:
CALL tbl3_init();
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 478:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 479:
MIGRATE TABLE tbl3 REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- tbl3 is replaced by a multitenant table
--Testcase 480:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                       | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl3__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- tbl3 is multitenant table
--Testcase 481:
\d tbl3
                              Foreign table "public.tbl3"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 482:
SELECT * FROM tbl3 ORDER BY c1, __spd_url;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+------+------------------------------+--------------------------+----+------------+-----------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv3/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv3/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /postgres_srv2/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /postgres_srv3/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /postgres_srv3/
(8 rows)

-- check data distribution
--Testcase 483:
SELECT count(*) FROM tbl3__postgres_srv2__0;
 count 
-------
     4
(1 row)

--Testcase 484:
SELECT count(*) FROM tbl3__postgres_srv3__0;
 count 
-------
     4
(1 row)

--Testcase 485:
DROP FOREIGN TABLE tbl3;
--Testcase 486:
DROP DATASOURCE TABLE tbl3__postgres_srv2__0;
--Testcase 487:
DROP DATASOURCE TABLE tbl3__postgres_srv3__0;
--Testcase 488:
DROP FOREIGN TABLE tbl3__postgres_srv2__0;
--Testcase 489:
DROP FOREIGN TABLE tbl3__postgres_srv3__0;
-- re-init tbl3 to execute test after
--Testcase 490:
CALL tbl3_init();
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 491:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 492:
MIGRATE TABLE tbl3 TO tbl3_new SERVER postgres_srv2;
-- new foreign table created
--Testcase 493:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new               | postgres_srv2     | (table_name 'tbl3')                   | 
(5 rows)

-- tbl3_new is postgres foreign table
--Testcase 494:
\d tbl3_new
                           Foreign table "public.tbl3_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'tbl3')

--Testcase 495:
SELECT * FROM tbl3_new ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 496:
DROP DATASOURCE TABLE tbl3_new;
--Testcase 497:
DROP FOREIGN TABLE tbl3_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 498:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 499:
MIGRATE TABLE tbl3 TO tbl3_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 500:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                   | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0 | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new               | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(5 rows)

-- tbl3_new is postgres foreign table
--Testcase 501:
\d tbl3_new
                           Foreign table "public.tbl3_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 502:
SELECT * FROM tbl3_new ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 503:
DROP DATASOURCE TABLE tbl3_new;
--Testcase 504:
DROP FOREIGN TABLE tbl3_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 505:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 506:
MIGRATE TABLE tbl3 TO tbl3_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 507:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                       | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new                   | pgspider_core_srv |                                       | 
 public | tbl3_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl3_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2') | 
(7 rows)

-- tbl3_new is multitenant table
--Testcase 508:
\d tbl3_new
                            Foreign table "public.tbl3_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 509:
SELECT * FROM tbl3_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+------+------------------------------+--------------------------+----+------------+-----------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv3/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv3/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv3/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /postgres_srv2/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /postgres_srv3/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /postgres_srv2/
(8 rows)

-- check data distribution
--Testcase 510:
SELECT count(*) FROM tbl3_new__postgres_srv2__0;
 count 
-------
     4
(1 row)

--Testcase 511:
SELECT count(*) FROM tbl3_new__postgres_srv3__0;
 count 
-------
     4
(1 row)

--Testcase 512:
DROP FOREIGN TABLE tbl3_new;
--Testcase 513:
DROP DATASOURCE TABLE tbl3_new__postgres_srv2__0;
--Testcase 514:
DROP DATASOURCE TABLE tbl3_new__postgres_srv3__0;
--Testcase 515:
DROP FOREIGN TABLE tbl3_new__postgres_srv2__0;
--Testcase 516:
DROP FOREIGN TABLE tbl3_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 517:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 518:
MIGRATE TABLE tbl3 TO tbl3_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2;
-- new multitenant table created
--Testcase 519:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                       | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new                   | pgspider_core_svr |                                       | 
 public | tbl3_new__postgres_srv2__0 | postgres_srv2     | (table_name 'tbl3')                   | 
(6 rows)

-- tbl3_new is multitenant table
--Testcase 520:
\d tbl3_new
                            Foreign table "public.tbl3_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 521:
SELECT * FROM tbl3_new ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+------+------------------------------+--------------------------+----+------------+-----------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /postgres_srv2/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /postgres_srv2/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /postgres_srv2/
(8 rows)

-- check data distribution
--Testcase 522:
SELECT * FROM tbl3_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 523:
DROP FOREIGN TABLE tbl3_new;
--Testcase 524:
DROP DATASOURCE TABLE tbl3_new__postgres_srv2__0;
--Testcase 525:
DROP FOREIGN TABLE tbl3_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 526:
SELECT * FROM tbl3 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |           __spd_url           
----+----+------+------------------------------+--------------------------+----+------------+-------------------------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv1/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv1/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /pgspider_srv1/postgres_srv1/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /pgspider_srv1/postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /pgspider_srv1/postgres_srv2/
(8 rows)

--Testcase 527:
MIGRATE TABLE tbl3 TO tbl3_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 528:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                       | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new                   | pgspider_core_svr |                                       | 
 public | tbl3_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
(6 rows)

-- tbl3_new is multitenant table
--Testcase 529:
\d tbl3_new
                            Foreign table "public.tbl3_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 530:
SELECT * FROM tbl3_new ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+------+------------------------------+--------------------------+----+------------+-----------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv2/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /postgres_srv2/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /postgres_srv2/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /postgres_srv2/
(8 rows)

-- check data distribution
--Testcase 531:
SELECT * FROM tbl3_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     
----+----+------+------------------------------+--------------------------+----+------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1      
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1      
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1      
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1      
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1    
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1    
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2    
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2    
(8 rows)

--Testcase 532:
DROP FOREIGN TABLE tbl3_new;
--Testcase 533:
DROP DATASOURCE TABLE tbl3_new__postgres_srv2__0;
--Testcase 534:
DROP FOREIGN TABLE tbl3_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 535:
MIGRATE TABLE tbl3 TO tbl3_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 536:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl3                       | pgspider_core_srv |                                       | 
 public | tbl3__pgspider_srv1__0     | pgspider_srv1     | (table_name 'tbl3')                   | 
 public | tbl3__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 1') | 
 public | tbl3_new                   | pgspider_core_svr |                                       | 
 public | tbl3_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl3_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(7 rows)

-- tbl3_new is multitenant table
--Testcase 537:
\d tbl3_new
                            Foreign table "public.tbl3_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 538:
SELECT * FROM tbl3_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3  |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+------+------------------------------+--------------------------+----+------------+-----------------
  0 |  0 | foo  | Sat Oct 08 21:00:00 2022 PDT | Sun Oct 09 12:00:00 2022 | 0  | tbl1       | /postgres_srv3/
  1 |  1 | bar  | Fri Oct 07 21:00:00 2022 PDT | Sat Oct 08 12:00:00 2022 | 1  | tbl1       | /postgres_srv3/
 10 |  0 | foo  | Wed Oct 05 21:00:00 2022 PDT | Thu Oct 06 12:00:00 2022 | 0  | tbl1       | /postgres_srv3/
 11 |  1 | bar  | Thu Oct 06 21:00:00 2022 PDT | Fri Oct 07 12:00:00 2022 | 1  | tbl1       | /postgres_srv2/
 20 |  0 | foo  | Sun Oct 09 21:00:00 2022 PDT | Mon Oct 10 12:00:00 2022 | 20 | tbl3_1     | /postgres_srv2/
 21 |  1 | bar  | Mon Oct 10 21:00:00 2022 PDT | Tue Oct 11 12:00:00 2022 | 21 | tbl3_1     | /postgres_srv3/
 30 |  0 | foo1 | Wed Oct 19 21:00:00 2022 PDT | Thu Oct 20 12:00:00 2022 | 20 | tbl3_2     | /postgres_srv2/
 31 |  1 | bar1 | Thu Oct 20 21:00:00 2022 PDT | Fri Oct 21 12:00:00 2022 | 21 | tbl3_2     | /postgres_srv2/
(8 rows)

-- check data distribution
--Testcase 539:
SELECT count(*) FROM tbl3_new__postgres_srv2__0;
 count 
-------
     4
(1 row)

--Testcase 540:
SELECT count(*) FROM tbl3_new__postgres_srv3__0;
 count 
-------
     4
(1 row)

--Testcase 541:
DROP FOREIGN TABLE tbl3_new;
--Testcase 542:
DROP DATASOURCE TABLE tbl3_new__postgres_srv2__0;
--Testcase 543:
DROP DATASOURCE TABLE tbl3_new__postgres_srv3__0;
--Testcase 544:
DROP FOREIGN TABLE tbl3_new__postgres_srv2__0;
--Testcase 545:
DROP FOREIGN TABLE tbl3_new__postgres_srv3__0;
-- clean-up
--Testcase 546:
DROP DATASOURCE TABLE tbl3__postgres_srv1__0;
--Testcase 547:
DROP DATASOURCE TABLE tbl3__postgres_srv2__0;
--Testcase 548:
DROP FOREIGN TABLE tbl3__postgres_srv1__0;
--Testcase 549:
DROP FOREIGN TABLE tbl3__postgres_srv2__0;
--Testcase 550:
DROP FOREIGN TABLE tbl3__pgspider_srv1__0;
--Testcase 551:
DROP FOREIGN TABLE tbl3;
----------------------------------------------------------
-- end source structure tbl3
-- PGSpider Top Node --|-> Postgres child node
--                     |-> Postgres child node
--                     |-> pgspider_core_fdw -> PGSpider |-> pgspider_core_fdw  |-> Postgres child node
--                                                                             |-> Postgres child node
----------------------------------------------------------
----------------------------------------------------------
-- source table 'replace'
-- table name same as keyword
----------------------------------------------------------
--Testcase 552:
CREATE PROCEDURE replace_init()
LANGUAGE SQL
AS $$
    CREATE FOREIGN TABLE IF NOT EXISTS replace (
            c1 int NOT NULL,
            c2 int NOT NULL,
            c3 text,
            c4 timestamptz,
            c5 timestamp,
            c6 varchar(10),
            c7 char(10) default 'tbl1'
        ) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'replace');
--Testcase 553:
    CREATE DATASOURCE TABLE IF NOT EXISTS replace;
$$;
--Testcase 554:
CALL replace_init();
--Testcase 555:
INSERT INTO replace
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 10) id;
--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 556:
CREATE FOREIGN TABLE replace_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'replace'
) SERVER postgres_srv1 OPTIONS (table_name 'replace');
-- ERROR: datasource table does not create yet
--Testcase 557:
SELECT * FROM replace_datasource ORDER BY c1;
ERROR:  relation "public.replace" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.replace ORDER BY c1 ASC NULLS LAST
--Testcase 558:
MIGRATE TABLE replace SERVER postgres_srv1;
-- no new foreign table created
--Testcase 559:
\det+
                                        List of foreign tables
 Schema |       Table        |    Server     |                FDW options                | Description 
--------+--------------------+---------------+-------------------------------------------+-------------
 public | replace            | postgres_srv1 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_datasource | postgres_srv1 | (table_name 'replace')                    | 
(2 rows)

-- OK: datasource table created
--Testcase 560:
SELECT * FROM replace_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 561:
DROP DATASOURCE TABLE replace_datasource;
--Testcase 562:
DROP FOREIGN TABLE replace_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 563:
CREATE FOREIGN TABLE replace_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'replace'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'replace');
-- ERROR: datasource table does not create yet
--Testcase 564:
SELECT * FROM replace_datasource ORDER BY c1;
ERROR:  relation "S 2.replace" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".replace ORDER BY c1 ASC NULLS LAST
--Testcase 565:
MIGRATE TABLE replace SERVER postgres_srv2 OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 566:
\det+
                                        List of foreign tables
 Schema |       Table        |    Server     |                FDW options                | Description 
--------+--------------------+---------------+-------------------------------------------+-------------
 public | replace            | postgres_srv1 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_datasource | postgres_srv2 | (schema_name 'S 2', table_name 'replace') | 
(2 rows)

-- OK: datasource table created
--Testcase 567:
SELECT * FROM replace_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 568:
DROP DATASOURCE TABLE replace_datasource;
--Testcase 569:
DROP FOREIGN TABLE replace_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 570:
CREATE FOREIGN TABLE replace_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'replace'
) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'replace');
--Testcase 571:
CREATE FOREIGN TABLE replace_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'replace'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'replace');
-- ERROR: datasource table does not create yet
--Testcase 572:
SELECT * FROM replace_datasource1 ORDER BY c1;
ERROR:  relation "S 1.replace" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".replace ORDER BY c1 ASC NULLS LAST
--Testcase 573:
SELECT * FROM replace_datasource2 ORDER BY c1;
ERROR:  relation "S 1.replace" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".replace ORDER BY c1 ASC NULLS LAST
--Testcase 574:
MIGRATE TABLE replace SERVER postgres_srv2 OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 575:
\det+
                                         List of foreign tables
 Schema |        Table        |    Server     |                FDW options                | Description 
--------+---------------------+---------------+-------------------------------------------+-------------
 public | replace             | postgres_srv1 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_datasource1 | postgres_srv2 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_datasource2 | postgres_srv3 | (schema_name 'S 1', table_name 'replace') | 
(3 rows)

-- OK: datasource table created
--Testcase 576:
SELECT * FROM replace_datasource1 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
(5 rows)

--Testcase 577:
SELECT * FROM replace_datasource2 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(5 rows)

-- clean-up
--Testcase 578:
DROP DATASOURCE TABLE replace_datasource1;
--Testcase 579:
DROP DATASOURCE TABLE replace_datasource2;
--Testcase 580:
DROP FOREIGN TABLE replace_datasource1;
--Testcase 581:
DROP FOREIGN TABLE replace_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 582:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 583:
MIGRATE TABLE replace REPLACE SERVER postgres_srv2;
-- no new foreign table created
--Testcase 584:
\det+
                         List of foreign tables
 Schema |  Table  |    Server     |      FDW options       | Description 
--------+---------+---------------+------------------------+-------------
 public | replace | postgres_srv2 | (table_name 'replace') | 
(1 row)

-- replace is postgres foreign table now.
--Testcase 585:
\d replace
                           Foreign table "public.replace"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'replace')

--Testcase 586:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 587:
DROP DATASOURCE TABLE replace;
--Testcase 588:
DROP FOREIGN TABLE replace;
-- re-init replace to execute test after
--Testcase 589:
CALL replace_init();
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 590:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 591:
MIGRATE TABLE replace REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 592:
\det+
                                 List of foreign tables
 Schema |  Table  |    Server     |              FDW options              | Description 
--------+---------+---------------+---------------------------------------+-------------
 public | replace | postgres_srv2 | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- replace is postgres foreign table now.
--Testcase 593:
\d replace
                           Foreign table "public.replace"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 594:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 595:
DROP DATASOURCE TABLE replace;
--Testcase 596:
DROP FOREIGN TABLE replace;
-- re-init replace to execute test after
--Testcase 597:
CALL replace_init();
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 598:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 599:
MIGRATE TABLE replace REPLACE SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new foreign table created
--Testcase 600:
\det+
                                            List of foreign tables
 Schema |           Table           |      Server       |              FDW options              | Description 
--------+---------------------------+-------------------+---------------------------------------+-------------
 public | replace                   | pgspider_core_svr |                                       | 
 public | replace__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2') | 
 public | replace__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
(3 rows)

-- replace is multitenant table
--Testcase 601:
\d replace
                             Foreign table "public.replace"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 602:
SELECT * FROM replace ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 603:
SELECT count(*) FROM replace__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 604:
SELECT count(*) FROM replace__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 605:
DROP FOREIGN TABLE replace;
--Testcase 606:
DROP DATASOURCE TABLE replace__postgres_srv2__0;
--Testcase 607:
DROP DATASOURCE TABLE replace__postgres_srv3__0;
--Testcase 608:
DROP FOREIGN TABLE replace__postgres_srv2__0;
--Testcase 609:
DROP FOREIGN TABLE replace__postgres_srv3__0;
-- re-init replace to execute test after
--Testcase 610:
CALL replace_init();
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 611:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 612:
MIGRATE TABLE replace TO replace_new SERVER postgres_srv2;
-- new foreign table created
--Testcase 613:
\det+
                                     List of foreign tables
 Schema |    Table    |    Server     |                FDW options                | Description 
--------+-------------+---------------+-------------------------------------------+-------------
 public | replace     | postgres_srv1 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new | postgres_srv2 | (table_name 'replace')                    | 
(2 rows)

-- replace_new is postgres foreign table
--Testcase 614:
\d replace_new
                         Foreign table "public.replace_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (table_name 'replace')

--Testcase 615:
SELECT * FROM replace_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 616:
DROP DATASOURCE TABLE replace_new;
--Testcase 617:
DROP FOREIGN TABLE replace_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 618:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 619:
MIGRATE TABLE replace TO replace_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 620:
\det+
                                     List of foreign tables
 Schema |    Table    |    Server     |                FDW options                | Description 
--------+-------------+---------------+-------------------------------------------+-------------
 public | replace     | postgres_srv1 | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new | postgres_srv2 | (schema_name 'S 2', table_name 'T 2')     | 
(2 rows)

-- replace_new is postgres foreign table
--Testcase 621:
\d replace_new
                         Foreign table "public.replace_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: postgres_srv2
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 622:
SELECT * FROM replace_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 623:
DROP DATASOURCE TABLE replace_new;
--Testcase 624:
DROP FOREIGN TABLE replace_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 625:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 626:
MIGRATE TABLE replace TO replace_new SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 627:
\det+
                                                List of foreign tables
 Schema |             Table             |      Server       |                FDW options                | Description 
--------+-------------------------------+-------------------+-------------------------------------------+-------------
 public | replace                       | postgres_srv1     | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new                   | pgspider_core_svr |                                           | 
 public | replace_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2')     | 
 public | replace_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2')     | 
(4 rows)

-- replace_new is multitenant table
--Testcase 628:
\d replace_new
                           Foreign table "public.replace_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 629:
SELECT * FROM replace_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 630:
SELECT count(*) FROM replace_new__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 631:
SELECT count(*) FROM replace_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 632:
DROP FOREIGN TABLE replace_new;
--Testcase 633:
DROP DATASOURCE TABLE replace_new__postgres_srv2__0;
--Testcase 634:
DROP DATASOURCE TABLE replace_new__postgres_srv3__0;
--Testcase 635:
DROP FOREIGN TABLE replace_new__postgres_srv2__0;
--Testcase 636:
DROP FOREIGN TABLE replace_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 637:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 638:
MIGRATE TABLE replace TO replace_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2;
-- new multitenant table created
--Testcase 639:
\det+
                                                List of foreign tables
 Schema |             Table             |      Server       |                FDW options                | Description 
--------+-------------------------------+-------------------+-------------------------------------------+-------------
 public | replace                       | postgres_srv1     | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new                   | pgspider_core_svr |                                           | 
 public | replace_new__postgres_srv2__0 | postgres_srv2     | (table_name 'replace')                    | 
(3 rows)

-- replace_new is multitenant table
--Testcase 640:
\d replace_new
                           Foreign table "public.replace_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 641:
SELECT * FROM replace_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

-- check data distribution
--Testcase 642:
SELECT * FROM replace_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 643:
DROP FOREIGN TABLE replace_new;
--Testcase 644:
DROP DATASOURCE TABLE replace_new__postgres_srv2__0;
--Testcase 645:
DROP FOREIGN TABLE replace_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 646:
SELECT * FROM replace ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 647:
MIGRATE TABLE replace TO replace_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 648:
\det+
                                                List of foreign tables
 Schema |             Table             |      Server       |                FDW options                | Description 
--------+-------------------------------+-------------------+-------------------------------------------+-------------
 public | replace                       | postgres_srv1     | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new                   | pgspider_core_svr |                                           | 
 public | replace_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2')     | 
(3 rows)

-- replace_new is multitenant table
--Testcase 649:
\d replace_new
                           Foreign table "public.replace_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 650:
SELECT * FROM replace_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv2/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv2/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

-- check data distribution
--Testcase 651:
SELECT * FROM replace_new__postgres_srv2__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 652:
DROP FOREIGN TABLE replace_new;
--Testcase 653:
DROP DATASOURCE TABLE replace_new__postgres_srv2__0;
--Testcase 654:
DROP FOREIGN TABLE replace_new__postgres_srv2__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 655:
MIGRATE TABLE replace TO replace_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER postgres_srv2 OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 656:
\det+
                                                List of foreign tables
 Schema |             Table             |      Server       |                FDW options                | Description 
--------+-------------------------------+-------------------+-------------------------------------------+-------------
 public | replace                       | postgres_srv1     | (schema_name 'S 1', table_name 'replace') | 
 public | replace_new                   | pgspider_core_svr |                                           | 
 public | replace_new__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 2', table_name 'T 2')     | 
 public | replace_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2')     | 
(4 rows)

-- replace_new is multitenant table
--Testcase 657:
\d replace_new
                           Foreign table "public.replace_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 658:
SELECT * FROM replace_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv2/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv3/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv2/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv3/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv2/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv3/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv3/
(10 rows)

-- check data distribution
--Testcase 659:
SELECT count(*) FROM replace_new__postgres_srv2__0;
 count 
-------
     5
(1 row)

--Testcase 660:
SELECT count(*) FROM replace_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 661:
DROP FOREIGN TABLE replace_new;
--Testcase 662:
DROP DATASOURCE TABLE replace_new__postgres_srv2__0;
--Testcase 663:
DROP DATASOURCE TABLE replace_new__postgres_srv3__0;
--Testcase 664:
DROP FOREIGN TABLE replace_new__postgres_srv2__0;
--Testcase 665:
DROP FOREIGN TABLE replace_new__postgres_srv3__0;
-- clean-up
--Testcase 666:
DROP DATASOURCE TABLE replace;
--Testcase 667:
DROP FOREIGN TABLE replace;
----------------------------------------------------------
-- source structure tbl4
-- PGSpider Top Node -> 3 posgres data source
----------------------------------------------------------
--Testcase 668:
CREATE SERVER replace FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host '127.0.0.1',
        port '25432',
        dbname 'postgres');
--Testcase 669:
CREATE USER MAPPING FOR public SERVER replace
    OPTIONS (user 'postgres', password 'postgres');
--Testcase 670:
CREATE PROCEDURE tbl4_init()
LANGUAGE SQL
AS $$
    CREATE FOREIGN TABLE IF NOT EXISTS tbl4 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl4',
        __spd_url text
    ) SERVER pgspider_core_srv;

--Testcase 671:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl4__postgres_srv1__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl4'
    ) SERVER postgres_srv1 OPTIONS (schema_name 'S 1', table_name 'T 4');
--Testcase 672:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl4__postgres_srv1__0;

--Testcase 673:
    CREATE FOREIGN TABLE IF NOT EXISTS tbl4__postgres_srv2__0 (
        c1 int NOT NULL,
        c2 int NOT NULL,
        c3 text,
        c4 timestamptz,
        c5 timestamp,
        c6 varchar(10),
        c7 char(10) default 'tbl4'
    ) SERVER postgres_srv2 OPTIONS (schema_name 'S 1', table_name 'T 4');
--Testcase 674:
    CREATE DATASOURCE TABLE IF NOT EXISTS tbl4__postgres_srv2__0;
$$;
--Testcase 675:
CALL tbl4_init();
-- Init data
--Testcase 676:
INSERT INTO tbl4__postgres_srv1__0
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(1, 5) id;
--Testcase 677:
INSERT INTO tbl4__postgres_srv2__0
    SELECT id,
            id % 10,
            to_char(id, 'FM00000'),
            '1970-01-01'::timestamptz + ((id % 100) || ' days')::interval,
            '1970-01-01'::timestamp + ((id % 100) || ' days')::interval,
            id % 10,
            id % 10
    FROM generate_series(6, 10) id;
--Testcase 678:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--
-- MIGRATE without TO/REPLACE , single server without any SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 679:
CREATE FOREIGN TABLE tbl4_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl4'
) SERVER postgres_srv1 OPTIONS (table_name 'tbl4');
-- ERROR: datasource table does not create yet
--Testcase 680:
SELECT * FROM tbl4_datasource ORDER BY c1;
ERROR:  relation "public.tbl4" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM public.tbl4 ORDER BY c1 ASC NULLS LAST
--Testcase 681:
MIGRATE TABLE tbl4 SERVER postgres_srv1;
-- no new foreign table created
--Testcase 682:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_datasource        | postgres_srv1     | (table_name 'tbl4')                   | 
(4 rows)

-- OK: datasource table created
--Testcase 683:
SELECT * FROM tbl4_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 684:
DROP DATASOURCE TABLE tbl4_datasource;
--Testcase 685:
DROP FOREIGN TABLE tbl4_datasource;
--
-- MIGRATE without TO/REPLACE , single server with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 686:
CREATE FOREIGN TABLE tbl4_datasource (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl4'
) SERVER replace OPTIONS (schema_name 'S 2', table_name 'tbl4');
-- ERROR: datasource table does not create yet
--Testcase 687:
SELECT * FROM tbl4_datasource ORDER BY c1;
ERROR:  relation "S 2.tbl4" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 2".tbl4 ORDER BY c1 ASC NULLS LAST
--Testcase 688:
MIGRATE TABLE tbl4 SERVER replace OPTIONS (schema_name 'S 2');
-- no new foreign table created
--Testcase 689:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                        | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4')  | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4')  | 
 public | tbl4_datasource        | replace           | (schema_name 'S 2', table_name 'tbl4') | 
(4 rows)

-- OK: datasource table created
--Testcase 690:
SELECT * FROM tbl4_datasource ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

-- clean-up
--Testcase 691:
DROP DATASOURCE TABLE tbl4_datasource;
--Testcase 692:
DROP FOREIGN TABLE tbl4_datasource;
--
-- MIGRATE without TO/REPLACE , multi servers with SERVER OPTION
--
-- Only datasource table will be created, so using an temporary foreign table to check this data
--Testcase 693:
CREATE FOREIGN TABLE tbl4_datasource1 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl4'
) SERVER replace OPTIONS (schema_name 'S 1', table_name 'tbl4');
--Testcase 694:
CREATE FOREIGN TABLE tbl4_datasource2 (
    c1 int NOT NULL,
    c2 int NOT NULL,
    c3 text,
    c4 timestamptz,
    c5 timestamp,
    c6 varchar(10),
    c7 char(10) default 'tbl4'
) SERVER postgres_srv3 OPTIONS (schema_name 'S 1', table_name 'tbl4');
-- ERROR: datasource table does not create yet
--Testcase 695:
SELECT * FROM tbl4_datasource1 ORDER BY c1;
ERROR:  relation "S 1.tbl4" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl4 ORDER BY c1 ASC NULLS LAST
--Testcase 696:
SELECT * FROM tbl4_datasource2 ORDER BY c1;
ERROR:  relation "S 1.tbl4" does not exist
CONTEXT:  remote SQL command: SELECT c1, c2, c3, c4, c5, c6, c7 FROM "S 1".tbl4 ORDER BY c1 ASC NULLS LAST
--Testcase 697:
MIGRATE TABLE tbl4 SERVER replace OPTIONS (schema_name 'S 1'), postgres_srv3 OPTIONS (schema_name 'S 1');
-- no new foreign table created
--Testcase 698:
\det+
                                           List of foreign tables
 Schema |         Table          |      Server       |              FDW options               | Description 
--------+------------------------+-------------------+----------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                        | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4')  | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4')  | 
 public | tbl4_datasource1       | replace           | (schema_name 'S 1', table_name 'tbl4') | 
 public | tbl4_datasource2       | postgres_srv3     | (schema_name 'S 1', table_name 'tbl4') | 
(5 rows)

-- OK: datasource table created
SELECT * FROM tbl4 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 699:
SELECT count(*) FROM tbl4_datasource1;
 count 
-------
     5
(1 row)

--Testcase 700:
SELECT count(*) FROM tbl4_datasource2;
 count 
-------
     5
(1 row)

-- clean-up
--Testcase 701:
DROP DATASOURCE TABLE tbl4_datasource1;
--Testcase 702:
DROP DATASOURCE TABLE tbl4_datasource2;
--Testcase 703:
DROP FOREIGN TABLE tbl4_datasource1;
--Testcase 704:
DROP FOREIGN TABLE tbl4_datasource2;
--
-- MIGRATE REPLACE , single server without any SERVER OPTION
--
--Testcase 705:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 706:
MIGRATE TABLE tbl4 REPLACE SERVER replace;
-- new foreign table created
--Testcase 707:
\det+
                    List of foreign tables
 Schema | Table | Server  |     FDW options     | Description 
--------+-------+---------+---------------------+-------------
 public | tbl4  | replace | (table_name 'tbl4') | 
(1 row)

-- tbl4 is postgres foreign table now.
--Testcase 708:
\d tbl4
                             Foreign table "public.tbl4"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: replace
FDW options: (table_name 'tbl4')

--Testcase 709:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 710:
DROP DATASOURCE TABLE tbl4;
--Testcase 711:
DROP FOREIGN TABLE tbl4;
-- re-init tbl4 to execute test after
--Testcase 712:
CALL tbl4_init();
--
-- MIGRATE REPLACE , single server with SERVER OPTION
--
--Testcase 713:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 714:
MIGRATE TABLE tbl4 REPLACE SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 715:
\det+
                             List of foreign tables
 Schema | Table | Server  |              FDW options              | Description 
--------+-------+---------+---------------------------------------+-------------
 public | tbl4  | replace | (schema_name 'S 2', table_name 'T 2') | 
(1 row)

-- tbl4 is postgres foreign table now.
--Testcase 716:
\d tbl4
                             Foreign table "public.tbl4"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: replace
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 717:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 718:
DROP DATASOURCE TABLE tbl4;
--Testcase 719:
DROP FOREIGN TABLE tbl4;
-- re-init tbl4 to execute test after
--Testcase 720:
CALL tbl4_init();
--
-- MIGRATE REPLACE , multi servers with SERVER OPTION
--
--Testcase 721:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 722:
MIGRATE TABLE tbl4 REPLACE SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 723:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
 public | tbl4__replace__0       | replace           | (schema_name 'S 2', table_name 'T 2') | 
(3 rows)

-- tbl4 is multitenant table
--Testcase 724:
\d tbl4
                              Foreign table "public.tbl4"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 725:
SELECT * FROM tbl4 ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv3/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /replace/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv3/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /replace/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /replace/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /replace/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv3/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /replace/
(10 rows)

-- check data distribution
--Testcase 726:
SELECT count(*) FROM tbl4__replace__0;
 count 
-------
     5
(1 row)

--Testcase 727:
SELECT count(*) FROM tbl4__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 728:
DROP FOREIGN TABLE tbl4;
--Testcase 729:
DROP DATASOURCE TABLE tbl4__replace__0;
--Testcase 730:
DROP DATASOURCE TABLE tbl4__postgres_srv3__0;
--Testcase 731:
DROP FOREIGN TABLE tbl4__replace__0;
--Testcase 732:
DROP FOREIGN TABLE tbl4__postgres_srv3__0;
-- re-init tbl4 to execute test after
--Testcase 733:
CALL tbl4_init();
--
-- MIGRATE TO , single server without any SERVER OPTION
--
--Testcase 734:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 735:
MIGRATE TABLE tbl4 TO tbl4_new SERVER replace;
-- new foreign table created
--Testcase 736:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new               | replace           | (table_name 'tbl4')                   | 
(4 rows)

-- tbl4_new is postgres foreign table
--Testcase 737:
\d tbl4_new
                           Foreign table "public.tbl4_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: replace
FDW options: (table_name 'tbl4')

--Testcase 738:
SELECT * FROM tbl4_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 739:
DROP DATASOURCE TABLE tbl4_new;
--Testcase 740:
DROP FOREIGN TABLE tbl4_new;
--
-- MIGRATE TO , single server with SERVER OPTION
--
--Testcase 741:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 742:
MIGRATE TABLE tbl4 TO tbl4_new SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new foreign table created
--Testcase 743:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new               | replace           | (schema_name 'S 2', table_name 'T 2') | 
(4 rows)

-- tbl4_new is postgres foreign table
--Testcase 744:
\d tbl4_new
                           Foreign table "public.tbl4_new"
 Column |            Type             | Collation | Nullable | Default | FDW options 
--------+-----------------------------+-----------+----------+---------+-------------
 c1     | integer                     |           | not null |         | 
 c2     | integer                     |           | not null |         | 
 c3     | text                        |           |          |         | 
 c4     | timestamp with time zone    |           |          |         | 
 c5     | timestamp without time zone |           |          |         | 
 c6     | character varying(10)       |           |          |         | 
 c7     | character(10)               |           |          |         | 
Server: replace
FDW options: (schema_name 'S 2', table_name 'T 2')

--Testcase 745:
SELECT * FROM tbl4_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 746:
DROP DATASOURCE TABLE tbl4_new;
--Testcase 747:
DROP FOREIGN TABLE tbl4_new;
--
-- MIGRATE TO , multi servers with SERVER OPTION
--
--Testcase 748:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 749:
MIGRATE TABLE tbl4 TO tbl4_new SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 750:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                       | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new                   | pgspider_core_srv |                                       | 
 public | tbl4_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 2', table_name 'T 2') | 
 public | tbl4_new__replace__0       | replace           | (schema_name 'S 2', table_name 'T 2') | 
(6 rows)

-- tbl4_new is multitenant table
--Testcase 751:
\d tbl4_new
                            Foreign table "public.tbl4_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_srv

--Testcase 752:
SELECT * FROM tbl4_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv3/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /replace/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv3/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /replace/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /replace/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /replace/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv3/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /replace/
(10 rows)

-- check data distribution
--Testcase 753:
SELECT count(*) FROM tbl4_new__replace__0;
 count 
-------
     5
(1 row)

--Testcase 754:
SELECT count(*) FROM tbl4_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 755:
DROP FOREIGN TABLE tbl4_new;
--Testcase 756:
DROP DATASOURCE TABLE tbl4_new__replace__0;
--Testcase 757:
DROP DATASOURCE TABLE tbl4_new__postgres_srv3__0;
--Testcase 758:
DROP FOREIGN TABLE tbl4_new__replace__0;
--Testcase 759:
DROP FOREIGN TABLE tbl4_new__postgres_srv3__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server without any SERVER OPTION
--
--Testcase 760:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 761:
MIGRATE TABLE tbl4 TO tbl4_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER replace;
-- new multitenant table created
--Testcase 762:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new               | pgspider_core_svr |                                       | 
 public | tbl4_new__replace__0   | replace           | (table_name 'tbl4')                   | 
(5 rows)

-- tbl4_new is multitenant table
--Testcase 763:
\d tbl4_new
                            Foreign table "public.tbl4_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 764:
SELECT * FROM tbl4_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     | __spd_url 
----+----+-------+------------------------------+--------------------------+----+------------+-----------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /replace/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /replace/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /replace/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /replace/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /replace/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /replace/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /replace/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /replace/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /replace/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /replace/
(10 rows)

-- check data distribution
--Testcase 765:
SELECT * FROM tbl4_new__replace__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 766:
DROP FOREIGN TABLE tbl4_new;
--Testcase 767:
DROP DATASOURCE TABLE tbl4_new__replace__0;
--Testcase 768:
DROP FOREIGN TABLE tbl4_new__replace__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, single server with SERVER OPTION
--
--Testcase 769:
SELECT * FROM tbl4 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv1/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /postgres_srv1/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv1/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /postgres_srv1/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /postgres_srv1/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv2/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv2/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /postgres_srv2/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv2/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /postgres_srv2/
(10 rows)

--Testcase 770:
MIGRATE TABLE tbl4 TO tbl4_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2');
-- new multitenant table created
--Testcase 771:
\det+
                                          List of foreign tables
 Schema |         Table          |      Server       |              FDW options              | Description 
--------+------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                   | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0 | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0 | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new               | pgspider_core_svr |                                       | 
 public | tbl4_new__replace__0   | replace           | (schema_name 'S 2', table_name 'T 2') | 
(5 rows)

-- tbl4_new is multitenant table
--Testcase 772:
\d tbl4_new
                            Foreign table "public.tbl4_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 773:
SELECT * FROM tbl4_new ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     | __spd_url 
----+----+-------+------------------------------+--------------------------+----+------------+-----------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /replace/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /replace/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /replace/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /replace/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /replace/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /replace/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /replace/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /replace/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /replace/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /replace/
(10 rows)

-- check data distribution
--Testcase 774:
SELECT * FROM tbl4_new__replace__0 ORDER BY c1;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     
----+----+-------+------------------------------+--------------------------+----+------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1         
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2         
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3         
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4         
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5         
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6         
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7         
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8         
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9         
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0         
(10 rows)

--Testcase 775:
DROP FOREIGN TABLE tbl4_new;
--Testcase 776:
DROP DATASOURCE TABLE tbl4_new__replace__0;
--Testcase 777:
DROP FOREIGN TABLE tbl4_new__replace__0;
--
-- MIGRATE TO has USE_MULTITENANT_SERVER option, multi servers with SERVER OPTION
--
--Testcase 778:
MIGRATE TABLE tbl4 TO tbl4_new OPTIONS (USE_MULTITENANT_SERVER 'pgspider_core_svr') SERVER replace OPTIONS (schema_name 'S 2', table_name 'T 2'), postgres_srv3 OPTIONS (schema_name 'S 3', table_name 'T 2');
-- new multitenant table created
--Testcase 779:
\det+
                                            List of foreign tables
 Schema |           Table            |      Server       |              FDW options              | Description 
--------+----------------------------+-------------------+---------------------------------------+-------------
 public | tbl4                       | pgspider_core_srv |                                       | 
 public | tbl4__postgres_srv1__0     | postgres_srv1     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4__postgres_srv2__0     | postgres_srv2     | (schema_name 'S 1', table_name 'T 4') | 
 public | tbl4_new                   | pgspider_core_svr |                                       | 
 public | tbl4_new__postgres_srv3__0 | postgres_srv3     | (schema_name 'S 3', table_name 'T 2') | 
 public | tbl4_new__replace__0       | replace           | (schema_name 'S 2', table_name 'T 2') | 
(6 rows)

-- tbl4_new is multitenant table
--Testcase 780:
\d tbl4_new
                            Foreign table "public.tbl4_new"
  Column   |            Type             | Collation | Nullable | Default | FDW options 
-----------+-----------------------------+-----------+----------+---------+-------------
 c1        | integer                     |           | not null |         | 
 c2        | integer                     |           | not null |         | 
 c3        | text                        |           |          |         | 
 c4        | timestamp with time zone    |           |          |         | 
 c5        | timestamp without time zone |           |          |         | 
 c6        | character varying(10)       |           |          |         | 
 c7        | character(10)               |           |          |         | 
 __spd_url | text                        |           |          |         | 
Server: pgspider_core_svr

--Testcase 781:
SELECT * FROM tbl4_new ORDER BY c1, __spd_url;
 c1 | c2 |  c3   |              c4              |            c5            | c6 |     c7     |    __spd_url    
----+----+-------+------------------------------+--------------------------+----+------------+-----------------
  1 |  1 | 00001 | Fri Jan 02 00:00:00 1970 PST | Fri Jan 02 00:00:00 1970 | 1  | 1          | /postgres_srv3/
  2 |  2 | 00002 | Sat Jan 03 00:00:00 1970 PST | Sat Jan 03 00:00:00 1970 | 2  | 2          | /replace/
  3 |  3 | 00003 | Sun Jan 04 00:00:00 1970 PST | Sun Jan 04 00:00:00 1970 | 3  | 3          | /postgres_srv3/
  4 |  4 | 00004 | Mon Jan 05 00:00:00 1970 PST | Mon Jan 05 00:00:00 1970 | 4  | 4          | /replace/
  5 |  5 | 00005 | Tue Jan 06 00:00:00 1970 PST | Tue Jan 06 00:00:00 1970 | 5  | 5          | /replace/
  6 |  6 | 00006 | Wed Jan 07 00:00:00 1970 PST | Wed Jan 07 00:00:00 1970 | 6  | 6          | /postgres_srv3/
  7 |  7 | 00007 | Thu Jan 08 00:00:00 1970 PST | Thu Jan 08 00:00:00 1970 | 7  | 7          | /postgres_srv3/
  8 |  8 | 00008 | Fri Jan 09 00:00:00 1970 PST | Fri Jan 09 00:00:00 1970 | 8  | 8          | /replace/
  9 |  9 | 00009 | Sat Jan 10 00:00:00 1970 PST | Sat Jan 10 00:00:00 1970 | 9  | 9          | /postgres_srv3/
 10 |  0 | 00010 | Sun Jan 11 00:00:00 1970 PST | Sun Jan 11 00:00:00 1970 | 0  | 0          | /replace/
(10 rows)

-- check data distribution
--Testcase 782:
SELECT count(*) FROM tbl4_new__replace__0;
 count 
-------
     5
(1 row)

--Testcase 783:
SELECT count(*) FROM tbl4_new__postgres_srv3__0;
 count 
-------
     5
(1 row)

--Testcase 784:
DROP FOREIGN TABLE tbl4_new;
--Testcase 785:
DROP DATASOURCE TABLE tbl4_new__replace__0;
--Testcase 786:
DROP DATASOURCE TABLE tbl4_new__postgres_srv3__0;
--Testcase 787:
DROP FOREIGN TABLE tbl4_new__replace__0;
--Testcase 788:
DROP FOREIGN TABLE tbl4_new__postgres_srv3__0;
-- clean-up
--Testcase 789:
DROP DATASOURCE TABLE tbl4__postgres_srv1__0;
--Testcase 790:
DROP DATASOURCE TABLE tbl4__postgres_srv2__0;
--Testcase 791:
DROP FOREIGN TABLE tbl4__postgres_srv1__0;
--Testcase 792:
DROP FOREIGN TABLE tbl4__postgres_srv2__0;
--Testcase 793:
DROP FOREIGN TABLE tbl4;
----------------------------------------------------------
-- end testing for source structure tbl4
-- PGSpider Top Node -> 3 posgres data source
----------------------------------------------------------
